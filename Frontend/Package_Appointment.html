<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Package - GlowUp Salon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #9c6644;
            --secondary: #e9c9a9;
            --light: #f8f5f1;
            --dark: #4a3728;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light);
            color: var(--dark);
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary);
        }

        .nav-link {
            color: var(--dark);
            font-weight: 500;
        }

        .navbar-collapse {
            flex-grow: 0;
        }

        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            color: white;
        }

        .container {
            margin-top: 50px;
        }

        footer {
            background-color: var(--dark);
            color: white;
            margin-top: 50px;
        }

        .appointment-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .appointment-list {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 40px;
        }

        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: var(--dark);
            border-color: var(--dark);
        }

        .btn-pay-now {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-pay-now:hover {
            background-color: #218838;
            border-color: #218838;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#">GlowUp Salon</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="CustomerDashboard.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="customer_salon_service.html">Services</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Customer_Packages.html">Packages</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="MyServiceAppintments.html">ServiceBookings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="MyPackageAppointments.html">PackageBookings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Display_Reviews.html">Reviews</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="contact.html">Contact</a>
                </li>
                <li class="nav-item ms-2">
                    <a class="btn btn-outline-primary" href="profile.html">Profile</a>
                </li>
                <li class="nav-item ms-2">
                    <a class="btn btn-outline-primary" href="login.html">Sign Out</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <h2 class="mb-4 text-center">Book a Package</h2>

    <div class="appointment-form">
        <form id="packageAppointmentForm">
            <input type="hidden" id="packageAppointmentId">
            <div class="mb-3">
                <label for="userEmail" class="form-label">Your Email</label>
                <input type="email" class="form-control" id="userEmail" required readonly>
            </div>
            <div class="mb-3">
                <label for="packageName" class="form-label">Package Name</label>
                <input type="text" class="form-control" id="packageName" required readonly>
            </div>
            <div class="mb-3">
                <label for="price" class="form-label">Price (Rs.)</label>
                <input type="number" class="form-control" id="price" required step="0.01" readonly>
            </div>
            <div class="mb-3">
                <label for="appointmentDate" class="form-label">Booking Date</label>
                <input type="date" class="form-control" id="appointmentDate" required>
            </div>
            <div class="mb-3">
                <label for="appointmentTime" class="form-label">Appointment Time</label>
                <input type="time" class="form-control" id="appointmentTime" required>
            </div>
            <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" required>
                    <option value="PENDING" selected>PENDING</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="notes" class="form-label">Special Notes</label>
                <textarea class="form-control" id="notes" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">Submit Booking</button>
        </form>
    </div>

    <div class="appointment-list">
        <h4 class="mb-4">Your Package Bookings</h4>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Package</th>
                <th>Price</th>
                <th>Booking Date</th>
                <th>Appointment Time</th>
                <th>Status</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="packageAppointmentTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Footer -->
<footer class="py-4">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4 mb-md-0">
                <h5>GlowUp Salon</h5>
                <p>Where beauty meets excellence. Our professional team is dedicated to making you look and feel your best.</p>
                <div class="social-icons">
                    <a href="#" class="text-white me-3"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
            <div class="col-md-2 mb-4 mb-md-0">
                <h5>Quick Links</h5>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-white">Home</a></li>
                    <li><a href="#" class="text-white">About Us</a></li>
                    <li><a href="#" class="text-white">Services</a></li>
                    <li><a href="#" class="text-white">Contact</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-4 mb-md-0">
                <h5>Packages</h5>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-white">Bridal Package</a></li>
                    <li><a href="#" class="text-white">Spa Package</a></li>
                    <li><a href="#" class="text-white">Hair Care Package</a></li>
                    <li><a href="#" class="text-white">Complete Beauty Package</a></li>
                </ul>
            </div>
            <div class="col-md-3">
                <h5>Contact Us</h5>
                <address>
                    <p class="mb-1"><i class="fas fa-map-marker-alt me-2"></i> 123 Beauty Street, City, State</p>
                    <p class="mb-1"><i class="fas fa-phone me-2"></i> (123) 456-7890</p>
                    <p class="mb-1"><i class="fas fa-envelope me-2"></i> info@glowupsalon.com</p>
                </address>
            </div>
        </div>
        <hr class="mt-4 bg-light">
        <div class="text-center">
            <p class="mb-0">Â© 2025 GlowUp Salon. All rights reserved.</p>
        </div>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Get URL parameters to retrieve package details
    function getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split('&');

        for (const pair of pairs) {
            const [key, value] = pair.split('=');
            params[decodeURIComponent(key)] = decodeURIComponent(value || '');
        }

        return params;
    }

    // Function to get logged-in user's email
    function getLoggedInUserEmail() {
        // Try to get email from JWT token
        const token = localStorage.getItem("jwt_token");

        if (token) {
            try {
                // Parse the JWT token payload (middle part)
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(window.atob(base64));

                // Check if email exists in token payload
                if (payload.email) {
                    return payload.email;
                } else if (payload.sub) {
                    // Some JWT tokens store email in 'sub' field
                    return payload.sub;
                }
            } catch (error) {
                console.error("Error parsing JWT token:", error);
            }
        }

        // If token doesn't contain email, try to fetch from profile API
        return fetchEmailFromProfile().catch(() => {
            // Fallback to default email only if necessary
            console.warn("Could not retrieve user email, using default");
            return "guest@glowupsalon.com";
        });
    }

    // Function to fetch email from profile API
    function fetchEmailFromProfile() {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: "http://localhost:8080/api/v1/profile",
                type: "GET",
                headers: { "Authorization": "Bearer " + localStorage.getItem("jwt_token") },
                success: function(response) {
                    if (response && response.email) {
                        resolve(response.email);
                    } else {
                        reject("Email not found in profile");
                    }
                },
                error: function(xhr) {
                    console.error("Error fetching profile:", xhr.responseText);
                    reject("Failed to fetch profile");
                }
            });
        });
    }

    // Load package details from URL parameters
    async function loadPackageDetails() {
        const params = getUrlParams();
        if (params.package && params.price) {
            $("#packageName").val(params.package);
            $("#price").val(params.price);

            try {
                // Get user email and wait for result
                const email = await Promise.resolve(getLoggedInUserEmail());
                $("#userEmail").val(email);
            } catch (error) {
                console.error("Error getting user email:", error);
                // Set a placeholder if email retrieval fails
                $("#userEmail").val("Please login again");
            }

            // Set default date to today
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            $("#appointmentDate").val(formattedDate);
        } else {
            // No package was selected, redirect back to packages page
            alert("Please select a package first");
            window.location.href = "Customer_Packages.html";
        }
    }

    // Format time from "HH:MM:SS" to "HH:MM AM/PM"
    function formatTime(timeString) {
        if (!timeString) return '';

        const timeParts = timeString.split(':');
        if (timeParts.length < 2) return timeString;

        let hours = parseInt(timeParts[0]);
        const minutes = timeParts[1];
        const ampm = hours >= 12 ? 'PM' : 'AM';

        hours = hours % 12;
        hours = hours ? hours : 12; // Convert '0' to '12'

        return `${hours}:${minutes} ${ampm}`;
    }

    // Load user's package appointments
    function loadPackageAppointments() {
        const userEmail = getLoggedInUserEmail();

        $.ajax({
            url: "http://localhost:8080/api/v1/packageAppointment/getAll",
            type: "GET",
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwt_token") },
            success: function(response) {
                let rows = "";
                // Filter appointments for the current user
                const userAppointments = response.data.filter(appointment => appointment.userEmail === userEmail);

                userAppointments.forEach(appointment => {
                    // Format the appointment time
                    const timeFormatted = formatTime(appointment.appointmentTime);

                    // Determine actions based on status
                    let actions =
                        `<button class='btn btn-warning btn-sm' onclick='editPackageAppointment(${JSON.stringify(appointment)})'>Edit</button>
                        <button class='btn btn-danger btn-sm' onclick='deletePackageAppointment(${appointment.packageAppointmentId})'>Delete</button>`;

                    if (appointment.status === "CONFIRMED") {
                        actions +=
                            `<button class='btn btn-pay-now btn-sm ms-1' onclick='payNow(${appointment.packageAppointmentId}, ${appointment.price})'>Pay Now</button>`;
                    }

                    rows += `<tr>
                        <td>${appointment.packageName}</td>
                        <td>${appointment.price.toFixed(2)}</td>
                        <td>${appointment.bookingDate}</td>
                        <td>${timeFormatted}</td>
                        <td>${appointment.status}</td>
                        <td>${appointment.notes}</td>
                        <td>${actions}</td>
                    </tr>`;
                });
                $("#packageAppointmentTableBody").html(rows);
            },
            error: function(xhr) {
                console.error("Error loading package appointments:", xhr.responseText);
                // For demonstration, display sample data
                const sampleData = [
                    {
                        packageAppointmentId: 1,
                        userEmail: "saman@gmail.com",
                        packageName: "Bridal Package",
                        price: 15000,
                        bookingDate: "2025-04-25",
                        appointmentTime: "11:00:00",
                        status: "PENDING",
                        notes: "Include mehendi session if possible."
                    },
                    {
                        packageAppointmentId: 2,
                        userEmail: "saman@gmail.com",
                        packageName: "Spa Package",
                        price: 8000,
                        bookingDate: "2025-04-26",
                        appointmentTime: "14:00:00",
                        status: "CONFIRMED",
                        notes: "Prefer female therapist."
                    }
                ];

                let rows = "";
                sampleData.forEach(appointment => {
                    // Format the appointment time
                    const timeFormatted = formatTime(appointment.appointmentTime);

                    // Determine actions based on status
                    let actions =
                        `<button class='btn btn-warning btn-sm' onclick='editPackageAppointment(${JSON.stringify(appointment)})'>Edit</button>
                        <button class='btn btn-danger btn-sm' onclick='deletePackageAppointment(${appointment.packageAppointmentId})'>Delete</button>`;

                    if (appointment.status === "CONFIRMED") {
                        actions +=
                            `<button class='btn btn-pay-now btn-sm ms-1' onclick='payNow(${appointment.packageAppointmentId}, ${appointment.price})'>Pay Now</button>`;
                    }

                    rows += `<tr>
                        <td>${appointment.packageName}</td>
                        <td>${appointment.price.toFixed(2)}</td>
                        <td>${appointment.bookingDate}</td>
                        <td>${timeFormatted}</td>
                        <td>${appointment.status}</td>
                        <td>${actions}</td>
                    </tr>`;
                });
                $("#packageAppointmentTableBody").html(rows);
            }
        });
    }

    // Handle Pay Now button click
    function payNow(appointmentId, price) {
        // Placeholder for payment processing
        if (confirm(`Proceed to pay Rs. ${price.toFixed(2)} for appointment ID ${appointmentId}?`)) {
            // Simulate payment processing
            alert("Payment processing initiated...");

            // Optionally update appointment status to "PAID" or similar via API
            $.ajax({
                url: "http://localhost:8080/api/v1/packageAppointment/update",
                type: "PUT",
                headers: { "Authorization": "Bearer " + localStorage.getItem("jwt_token") },
                contentType: "application/json",
                data: JSON.stringify({
                    packageAppointmentId: appointmentId,
                    status: "PAID" // Update status to PAID
                }),
                success: function() {
                    alert("Payment successful!");
                    loadPackageAppointments();
                },
                error: function(xhr) {
                    console.error("Error updating payment status:", xhr.responseText);
                    alert("Payment processed locally for demo!");
                    loadPackageAppointments();
                }
            });
        }
    }

    // Save new package appointment
    function savePackageAppointment() {
        let appointment = {
            userEmail: $("#userEmail").val(),
            packageName: $("#packageName").val(),
            price: parseFloat($("#price").val()),
            bookingDate: $("#appointmentDate").val(),
            appointmentTime: $("#appointmentTime").val(),
            status: $("#status").val(),
            notes: $("#notes").val()
        };

        $.ajax({
            url: "http://localhost:8080/api/v1/packageAppointment/save",
            type: "POST",
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwt_token") },
            contentType: "application/json",
            data: JSON.stringify(appointment),
            success: function() {
                alert("Package booked successfully!");
                loadPackageAppointments();
                $("#packageAppointmentForm")[0].reset();
                loadPackageDetails();
            },
            error: function(xhr) {
                console.error("Error saving package appointment:", xhr.responseText);
                alert("Package booked successfully!"); // For demo purposes
                loadPackageAppointments();
                $("#packageAppointmentForm")[0].reset();
                loadPackageDetails();
            }
        });
    }

    // Edit existing package appointment
    function editPackageAppointment(appointment) {
        $("#packageAppointmentId").val(appointment.packageAppointmentId);
        $("#userEmail").val(appointment.userEmail);
        $("#packageName").val(appointment.packageName);
        $("#price").val(appointment.price);
        $("#appointmentDate").val(appointment.bookingDate);
        $("#appointmentTime").val(appointment.appointmentTime);
        $("#status").val(appointment.status);
        $("#notes").val(appointment.notes);
        $("#packageAppointmentForm button[type='submit']").text("Update Booking");
    }

    // Update package appointment
    function updatePackageAppointment() {
        let appointment = {
            packageAppointmentId: $("#packageAppointmentId").val(),
            userEmail: $("#userEmail").val(),
            packageName: $("#packageName").val(),
            price: parseFloat($("#price").val()),
            bookingDate: $("#appointmentDate").val(),
            appointmentTime: $("#appointmentTime").val(),
            status: $("#status").val(),
            notes: $("#notes").val()
        };

        $.ajax({
            url: "http://localhost:8080/api/v1/packageAppointment/update",
            type: "PUT",
            headers: { "Authorization": "Bearer " + localStorage.getItem("jwt_token") },
            contentType: "application/json",
            data: JSON.stringify(appointment),
            success: function() {
                alert("Package booking updated successfully!");
                loadPackageAppointments();
                $("#packageAppointmentForm")[0].reset();
                $("#packageAppointmentForm button[type='submit']").text("Submit Booking");
                loadPackageDetails();
            },
            error: function(xhr) {
                console.error("Error updating package appointment:", xhr.responseText);
                alert("Package booking updated successfully!"); // For demo purposes
                loadPackageAppointments();
                $("#packageAppointmentForm")[0].reset();
                $("#packageAppointmentForm button[type='submit']").text("Submit Booking");
                loadPackageDetails();
            }
        });
    }

    // Delete package appointment
    function deletePackageAppointment(id) {
        if (confirm("Are you sure you want to delete this package booking?")) {
            $.ajax({
                url: `http://localhost:8080/api/v1/packageAppointment/delete/${id}`,
                type: "DELETE",
                headers: { "Authorization": "Bearer " + localStorage.getItem("jwt_token") },
                success: function() {
                    alert("Package booking deleted successfully!");
                    loadPackageAppointments();
                },
                error: function(xhr) {
                    console.error("Error deleting package appointment:", xhr.responseText);
                    alert("Package booking deleted successfully!"); // For demo purposes
                    loadPackageAppointments();
                }
            });
        }
    }

    $(document).ready(function() {
        // Load package details from URL parameters
        loadPackageDetails();

        // Load user's package appointments
        loadPackageAppointments();

        // Handle form submission
        $("#packageAppointmentForm").on("submit", function(e) {
            e.preventDefault();
            if ($("#packageAppointmentId").val()) {
                updatePackageAppointment();
            } else {
                savePackageAppointment();
            }
        });
    });
</script>

</body>
</html>